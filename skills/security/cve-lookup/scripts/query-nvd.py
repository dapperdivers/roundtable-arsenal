#!/usr/bin/env python3
"""query-nvd.py â€” Query the NVD API for CVE information."""

import argparse
import json
import sys
from datetime import datetime, timedelta, timezone
from urllib.request import urlopen, Request
from urllib.parse import urlencode

NVD_API = "https://services.nvd.nist.gov/rest/json/cves/2.0"


def query_nvd(params: dict) -> list:
    """Query the NVD API and return CVE records."""
    url = f"{NVD_API}?{urlencode(params)}"
    req = Request(url, headers={"User-Agent": "roundtable-arsenal/1.0"})

    # NVD API key can be set via environment variable for higher rate limits
    import os
    api_key = os.environ.get("NVD_API_KEY")
    if api_key:
        req.add_header("apiKey", api_key)

    try:
        with urlopen(req, timeout=30) as resp:
            data = json.loads(resp.read())
    except Exception as e:
        print(f"Error querying NVD: {e}", file=sys.stderr)
        sys.exit(1)

    results = []
    for vuln in data.get("vulnerabilities", []):
        cve = vuln.get("cve", {})
        metrics = cve.get("metrics", {})

        # Extract CVSS v3.1 score if available
        cvss_data = {}
        for key in ["cvssMetricV31", "cvssMetricV30", "cvssMetricV2"]:
            if key in metrics and metrics[key]:
                cvss_data = metrics[key][0].get("cvssData", {})
                break

        descriptions = cve.get("descriptions", [])
        desc = next((d["value"] for d in descriptions if d["lang"] == "en"), "")

        results.append({
            "id": cve.get("id", ""),
            "description": desc,
            "published": cve.get("published", ""),
            "lastModified": cve.get("lastModified", ""),
            "cvssScore": cvss_data.get("baseScore"),
            "severity": cvss_data.get("baseSeverity", "UNKNOWN"),
            "vector": cvss_data.get("vectorString", ""),
            "references": [r["url"] for r in cve.get("references", [])[:5]],
        })

    return results


def main():
    parser = argparse.ArgumentParser(description="Query NVD for CVE information.")
    parser.add_argument("--cve", help="Specific CVE ID to look up")
    parser.add_argument("--keyword", help="Search by keyword")
    parser.add_argument("--severity", help="Filter by severity (comma-separated)")
    parser.add_argument("--days", type=int, help="CVEs from last N days")
    parser.add_argument("--limit", type=int, default=20, help="Max results")
    parser.add_argument("--format", choices=["json", "summary", "detailed"], default="json")
    args = parser.parse_args()

    params = {"resultsPerPage": args.limit}

    if args.cve:
        params["cveId"] = args.cve
    if args.keyword:
        params["keywordSearch"] = args.keyword
    if args.severity:
        params["cvssV3Severity"] = args.severity.upper()
    if args.days:
        end = datetime.now(timezone.utc)
        start = end - timedelta(days=args.days)
        params["pubStartDate"] = start.strftime("%Y-%m-%dT%H:%M:%S.000")
        params["pubEndDate"] = end.strftime("%Y-%m-%dT%H:%M:%S.000")

    results = query_nvd(params)

    if args.format == "summary":
        for r in results:
            score = r["cvssScore"] or "?"
            print(f"[{r['severity']}] {r['id']} (CVSS {score}): {r['description'][:100]}")
    elif args.format == "detailed":
        for r in results:
            print(f"\n{'='*60}")
            print(f"CVE: {r['id']}")
            print(f"Severity: {r['severity']} (CVSS {r['cvssScore'] or '?'})")
            print(f"Published: {r['published']}")
            print(f"Description: {r['description']}")
            print(f"Vector: {r['vector']}")
            print(f"References:")
            for ref in r["references"]:
                print(f"  - {ref}")
    else:
        json.dump(results, sys.stdout, indent=2)


if __name__ == "__main__":
    main()
