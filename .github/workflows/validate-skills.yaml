name: Validate Skills

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install pyyaml

      - name: Validate SKILL.md frontmatter
        run: |
          #!/usr/bin/env python3
          import yaml
          import glob
          import sys
          import re

          errors = []
          # Search all tier directories
          skill_files = []
          for tier in ["shared", "security", "intel", "comms"]:
              skill_files.extend(glob.glob(f"{tier}/**/SKILL.md", recursive=True))

          if not skill_files:
              print("ERROR: No SKILL.md files found!")
              sys.exit(1)

          print(f"Found {len(skill_files)} SKILL.md files")

          NAME_RE = re.compile(r'^[a-z][a-z0-9]*(-[a-z0-9]+)*$')

          for path in sorted(skill_files):
              with open(path) as f:
                  content = f.read()

              # Check for YAML frontmatter
              if not content.startswith("---"):
                  errors.append(f"{path}: Missing YAML frontmatter (must start with ---)")
                  continue

              parts = content.split("---", 2)
              if len(parts) < 3:
                  errors.append(f"{path}: Invalid frontmatter format")
                  continue

              try:
                  meta = yaml.safe_load(parts[1])
              except yaml.YAMLError as e:
                  errors.append(f"{path}: Invalid YAML: {e}")
                  continue

              if not isinstance(meta, dict):
                  errors.append(f"{path}: Frontmatter is not a mapping")
                  continue

              name = meta.get("name")
              desc = meta.get("description")

              if not name:
                  errors.append(f"{path}: Missing required field 'name'")
              elif not NAME_RE.match(name):
                  errors.append(f"{path}: Invalid name '{name}' — must be lowercase alphanumeric + hyphens")
              elif len(name) > 64:
                  errors.append(f"{path}: Name too long ({len(name)} > 64 chars)")

              if not desc:
                  errors.append(f"{path}: Missing required field 'description'")
              elif len(desc) > 1024:
                  errors.append(f"{path}: Description too long ({len(desc)} > 1024 chars)")

              # Verify name matches parent directory
              import os
              parent_dir = os.path.basename(os.path.dirname(path))
              if name and name != parent_dir:
                  errors.append(f"{path}: name '{name}' doesn't match directory '{parent_dir}'")

              print(f"  ✓ {path} — {name}")

          if errors:
              print(f"\n{len(errors)} error(s) found:")
              for e in errors:
                  print(f"  ✗ {e}")
              sys.exit(1)

          print("\nAll SKILL.md files valid! ✓")
        shell: python

      - name: Check script permissions
        run: |
          echo "Checking script files..."
          errors=0
          for tier in shared security intel comms; do
            while IFS= read -r script; do
              if [[ ! -x "$script" ]]; then
                echo "  ✗ Not executable: $script"
                errors=$((errors + 1))
              else
                echo "  ✓ $script"
              fi
            done < <(find "$tier" -name "*.sh" -o -name "*.py" 2>/dev/null | sort)
          done

          if [[ $errors -gt 0 ]]; then
            echo ""
            echo "$errors script(s) are not executable."
            echo "Fix with: chmod +x <script>"
            exit 1
          fi
          echo ""
          echo "All scripts are executable! ✓"

      - name: Validate skill directory structure
        run: |
          echo "Checking agentskills.io compliance..."
          errors=0
          for skill_md in $(find shared security intel comms -name "SKILL.md" 2>/dev/null | sort); do
            skill_dir=$(dirname "$skill_md")
            # Check for unexpected files at skill root (only SKILL.md + known dirs)
            for item in "$skill_dir"/*; do
              base=$(basename "$item")
              case "$base" in
                SKILL.md|scripts|references|assets|LICENSE*) ;;
                *) echo "  ⚠ Unexpected: $item"; ;;
              esac
            done
            echo "  ✓ $skill_dir"
          done
          echo "Structure check complete! ✓"
